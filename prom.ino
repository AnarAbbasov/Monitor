#include <avr/pgmspace.h>

// -------------------------
// 8080 → Arduino address bus
// -------------------------
const uint8_t addrPins[8] = {
  2,3,4,5,6,7,8,9
};

// -------------------------
// Arduino → 8080 data bus
// -------------------------
const uint8_t dataPins[8] = {
  10,11,12,13,A0,A1,A2,A3
};

// 8080 /RD pin
const uint8_t rdPin = 14;

// -------------------------------------------------------
// YOUR PROM IMAGE — ADDRESS‑ALIGNED, GAPS FILLED WITH 0xFF
// -------------------------------------------------------
const uint8_t rom[] PROGMEM = {
    /*0000*/ 0xC3,0x05,0x00,
    /*0003*/ 0xFF,0xFF,
    /*0005*/ 0x31,0x00,0x10,0x21,0x00,0x0C,0x4E,0x7E,0xD3,0x40,
    /*000F*/ 0xFF,
    /*0010*/ 0x7D,0xD3,0x00,0x79,0xD3,0x02,
    /*0016*/ 0xFF,
    /*0017*/ 0xCD,0x67,0x00,
    /*001A*/ 0xFF,0xFF,
    /*001C*/ 0xFE,0x08,
    /*001E*/ 0xFF,
    /*001F*/ 0xD2,0x33,0x00,
    /*0022*/ 0xFF,0xFF,
    /*0024*/ 0x47,0x79,0x17,0x17,0x17,0xE6,0xF8,
    /*002B*/ 0xFF,
    /*002C*/ 0xB0,0x4F,0xC3,0x13,0x00,
    /*0031*/ 0xFF,0xFF,
    /*0033*/ 0xFE,0x08,
    /*0035*/ 0xFF,
    /*0036*/ 0xC2,0x41,0x00,
    /*0039*/ 0xFF,0xFF,
    /*003B*/ 0x61,0xC3,0x0B,0x00,
    /*003F*/ 0xFF,0xFF,
    /*0041*/ 0xFE,0x09,
    /*0043*/ 0xFF,
    /*0044*/ 0xC2,0x4F,0x00,
    /*0047*/ 0xFF,0xFF,
    /*0049*/ 0x69,0xC3,0x0B,0x00,
    /*004D*/ 0xFF,0xFF,
    /*004F*/ 0xFE,0x0A,0xC2,0x5D,0x00,
    /*0054*/ 0xFF,0xFF,
    /*0056*/ 0x71,0x23,0xC3,0x0B,0x00,
    /*005B*/ 0xFF,0xFF,
    /*005D*/ 0xFE,0x0B,
    /*005F*/ 0xFF,
    /*0060*/ 0xC2,0x17,0x00,
    /*0063*/ 0xFF,0xFF,
    /*0065*/ 0xE9,
    /*0066*/ 0xFF,
    /*0067*/ 0x3E,0x00,
    /*0069*/ 0xFF,
    /*006A*/ 0xD3,0x03,
    /*006C*/ 0xFF,
    /*006D*/ 0xDB,0x03,
    /*006F*/ 0xFF,
    /*0070*/ 0xE6,0x0F,
    /*0072*/ 0xFF,
    /*0073*/ 0xFE,0x0F,
    /*0075*/ 0xFF,
    /*0076*/ 0xC2,0x6D,0x00,
    /*0079*/ 0xFF,0xFF,
    /*007B*/ 0xCD,0xC4,0x00,
    /*007E*/ 0xFF,0xFF,
    /*0080*/ 0xD5,0x16,0x03,
    /*0083*/ 0xFF,
    /*0084*/ 0x1E,0xFE,
    /*0086*/ 0xFF,
    /*0087*/ 0x7B,0xD3,0x03,
    /*008A*/ 0xFF,
    /*008B*/ 0x07,0x5F,0xDB,0x03,
    /*008F*/ 0xFF,
    /*0090*/ 0xE6,0x0F,
    /*0092*/ 0xFF,
    /*0093*/ 0xFE,0x0F,
    /*0095*/ 0xFF,
    /*0096*/ 0xC2,0xAA,0x00,
    /*0099*/ 0xFF,0xFF,
    /*009B*/ 0x15,0x7A,0xFE,0xFF,
    /*009F*/ 0xFF,
    /*00A0*/ 0xC2,0x87,0x00,
    /*00A3*/ 0xFF,0xFF,
    /*00A5*/ 0xC3,0x81,0x00,
    /*00A8*/ 0xFF,0xFF,
    /*00AA*/ 0xCD,0xC4,0x00,
    /*00AD*/ 0xFF,0xFF,
    /*00AF*/ 0x0F,0xD2,0xC1,0x00,
    /*00B3*/ 0xFF,0xFF,
    /*00B5*/ 0xF5,0x7A,0xC6,0x04,0x57,
    /*00BA*/ 0xF1,0xC3,0xAF,0x00,0x7A,
    /*00BF*/ 0xFF,0xFF,
    /*00C1*/ 0x7A,0xD1,0xC9,0xF5,0xD5,0x11,0x0E,0x02,
    /*00C9*/ 0xFF,0xFF,
    /*00CB*/ 0xD1,0xF1,0xC9
};

// -------------------------------------------------------
// SETUP
// -------------------------------------------------------
void setup() {
  // Address bus is input
  for (int i = 0; i < 8; i++)
    pinMode(addrPins[i], INPUT);

  // Data bus starts in high‑Z
  for (int i = 0; i < 8; i++)
    pinMode(dataPins[i], INPUT);

  pinMode(rdPin, INPUT);
}

// -------------------------------------------------------
// MAIN LOOP — EMULATE PROM READ CYCLE
// -------------------------------------------------------
void loop() {

  // 8080 pulls /RD LOW → wants a byte
  if (digitalRead(rdPin) == LOW) {

    // Read address bus
    uint16_t addr = 0;
    for (int i = 0; i < 8; i++)
      addr |= (digitalRead(addrPins[i]) << i);

    // Fetch byte from PROGMEM
    uint8_t value = pgm_read_byte(&rom[addr]);

    // Drive data bus
    for (int i = 0; i < 8; i++) {
      pinMode(dataPins[i], OUTPUT);
      digitalWrite(dataPins[i], (value >> i) & 1);
    }

    // Wait until /RD goes HIGH again
    while (digitalRead(rdPin) == LOW);

    // Release data bus (tri‑state)
    for (int i = 0; i < 8; i++)
      pinMode(dataPins[i], INPUT);
  }
}
